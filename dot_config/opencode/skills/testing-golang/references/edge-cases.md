# Goテストにおける一般的なエッジケース

このリファレンスは、包括的なGoユニットテストを書く際に考慮すべき一般的なエッジケースをリストアップしています。

## 文字列操作

### 空文字とホワイトスペース

- 空文字列: `""`
- ホワイトスペースのみ: `" "`, `"\t"`, `"\n"`
- 先頭/末尾のホワイトスペース: `" value "`, `"\tvalue\n"`
- 連続する複数のスペース: `"hello  world"`

### 特殊文字

- Unicode文字: `"こんにちは"`, `"emoji 🎉"`
- 改行: `"line1\nline2"`
- タブ: `"column1\tcolumn2"`
- ヌルバイト: `"text\x00here"`
- 特殊記号: `"!@#$%^&*()"`

### サイズの極値

- 非常に長い文字列（バッファサイズを超える）
- 1文字: `"a"`
- 最大長の文字列（制限されたフィールドの場合）

## 数値操作

### 整数のエッジケース

- ゼロ: `0`
- 負のゼロ（浮動小数点数の場合）: `-0.0`
- 正の最大値: `math.MaxInt64`, `math.MaxInt32`
- 負の最小値: `math.MinInt64`, `math.MinInt32`
- 1: `1`
- -1: `-1`
- 境界値: `n-1`, `n`, `n+1`

### 浮動小数点数のエッジケース

- ゼロ: `0.0`
- 負のゼロ: `-0.0`
- 無限大: `math.Inf(1)`, `math.Inf(-1)`
- NaN（非数）: `math.NaN()`
- 非常に小さい数: `1e-100`
- 非常に大きい数: `1e100`
- 精度の限界: `0.1 + 0.2`（正確には`0.3`にならない）

### 除算と剰余

- ゼロ除算
- ゼロによる剰余
- 負の被除数/除数
- 演算における整数オーバーフロー

## スライスと配列操作

### 空とnil

- nilスライス: `var s []int`（nil）
- 空スライス: `[]int{}`（nilではないが、len=0）
- 空配列: `[0]int{}`

### サイズケース

- 単一要素: `[]int{1}`
- 2要素（ペア操作用）: `[]int{1, 2}`
- 非常に大きいスライス（メモリ/パフォーマンス）
- 容量 > 長さのスライス

### インデックス操作

- 最初の要素: `s[0]`
- 最後の要素: `s[len(s)-1]`
- 範囲外（負の値、>= len）
- 空スライスのインデックスアクセス

### サブスライス

- フルスライス: `s[:]`
- 空のサブスライス: `s[0:0]`, `s[len(s):len(s)]`
- 単一要素: `s[0:1]`
- 容量を超える: `s[:cap(s)+1]`

## マップ操作

### nilと空

- nilマップ: `var m map[string]int`（nil）
- 空マップ: `map[string]int{}`（初期化済み、len=0）

### キーケース

- 存在しないキーへのアクセス
- 存在しないキーのゼロ値
- 存在しないキーの削除
- nilマップからの削除（panic）

### 並行アクセス

- 並行読み取り（安全）
- 並行書き込み（競合状態）
- 書き込み中の読み取り（競合状態）

## ポインタ操作

### nilポインタ

- nilポインタ: `var p *int`（nil）
- nilポインタのデリファレンス（panic）
- nilレシーバでのメソッド呼び出し
- 比較におけるnilポインタ

### ポインタ算術のシナリオ

- ゼロ値のアドレス
- ポインタのポインタ: `**int`
- ポインタの比較

## 時刻操作

### ゼロと特殊値

- ゼロ時刻: `time.Time{}`（IsZeroがtrueを返す）
- Unixエポック: `time.Unix(0, 0)`
- 遠い未来: `time.Date(9999, 12, 31, 23, 59, 59, 0, time.UTC)`
- 遠い過去: `time.Date(1, 1, 1, 0, 0, 0, 0, time.UTC)`

### Durationのエッジケース

- ゼロ期間: `0 * time.Second`
- 負の期間: `-5 * time.Minute`
- 最大期間: `1<<63 - 1`ナノ秒
- 最小期間: `-1 << 63`ナノ秒

### タイムゾーンケース

- UTC: `time.UTC`
- ローカルタイムゾーン: `time.Local`
- オフセット付きカスタムタイムゾーン
- サマータイム切り替え
- うるう秒（サポートされていないが考慮）

## チャネル操作

### nilとクローズされたチャネル

- nilチャネル: `var ch chan int`（nil）
- nilチャネルへの送信（永久ブロック）
- nilチャネルからの受信（永久ブロック）
- nilチャネルのクローズ（panic）
- クローズされたチャネル: 受信はゼロ値とfalseを返す
- クローズされたチャネルへの送信（panic）
- 既にクローズされたチャネルのクローズ（panic）

### バッファケース

- バッファなしチャネル: `make(chan int)`
- バッファ付きチャネル: `make(chan int, 10)`
- 満杯のバッファ付きチャネル
- 空のバッファ付きチャネル

## Context操作

### Contextの状態

- Backgroundコンテキスト: `context.Background()`
- TODOコンテキスト: `context.TODO()`
- キャンセル済みコンテキスト: `ctx.Err() == context.Canceled`
- デッドライン超過: `ctx.Err() == context.DeadlineExceeded`
- 既にキャンセルされた親

### デッドラインケース

- ゼロデッドライン: `time.Time{}`
- 過去のデッドライン
- 未来のデッドライン
- 親からのデッドライン継承

## エラーハンドリング

### nilとラップされたエラー

- nilエラー: `err == nil`
- 非nilエラー
- ラップされたエラー: `fmt.Errorf("wrap: %w", err)`
- 複数回ラップされたエラー
- `errors.Is()`でのエラー比較
- `errors.As()`でのエラー型アサーション

### センチネルエラー

- `io.EOF`
- `sql.ErrNoRows`
- カスタムセンチネルエラー

## ファイルとI/O操作

### ファイルの状態

- 存在しないファイル
- 空ファイル（0バイト）
- 読み取り専用ファイル
- ファイルではなくディレクトリ
- シンボリックリンク
- パーミッション拒否

### I/Oのエッジケース

- `io.EOF`
- 部分的な読み取り/書き込み
- 中断されたI/O
- クローズされたreader/writer
- バッファオーバーフロー

## 並行性

### Goroutineケース

- 競合状態
- デッドロック
- Goroutineリーク
- Goroutine内のpanic（mainをクラッシュさせない）
- WaitGroupカウンタが負になる（panic）

### Mutexケース

- アンロックされていないmutexのアンロック（panic）
- 再帰的ロック（Mutexでデッドロック）
- Goroutine境界を越えて保持されるロック

## JSON/アンマーシャリング

### JSONのエッジケース

- 空JSON: `{}`
- null値: `null`
- 欠落フィールド（ゼロ値が使用される）
- 余分なフィールド（デフォルトのアンマーシャリングでは無視）
- 無効なJSON構文
- 大きな数値（精度損失）
- Unicodeエスケープ: `"\u0041"`

### 構造体タグケース

- ゼロ値でのomitempty
- 文字列エンコードされた数値: `,string`
- 無視されるフィールド: `json:"-"`
- 埋め込み構造体
- ポインタフィールド（nilとゼロ値）

## データベース操作

### クエリ結果

- 行なし: `sql.ErrNoRows`
- 単一行
- 複数行
- カラムのNULL値
- Scanの型不一致

### トランザクションケース

- ロールバック後のコミット
- コミット後のロールバック
- ネストされたトランザクション（直接サポートされていない）
- トランザクション中の接続切断

## HTTP/ネットワーク

### リクエストケース

- nilリクエストボディ
- 空のリクエストボディ
- 非常に大きいリクエストボディ
- 無効なcontent-type
- 欠落ヘッダー
- タイムアウト

### レスポンスケース

- 1xx, 2xx, 3xx, 4xx, 5xxステータスコード
- 空のレスポンスボディ
- チャンクエンコーディング
- Gzip圧縮
- 接続リセット

### ネットワークエラー

- 接続タイムアウト
- 接続拒否
- DNS解決失敗
- TLS証明書エラー

## エッジケーステストのベストプラクティス

1. **常に境界値をテスト**: 0, 1, -1, max, min
2. **nilと空を別々にテスト**: しばしば異なる動作をする
3. **ゼロ値を考慮**: すべての型にはテストすべきゼロ値がある
4. **Unicode対応**: 非ASCII文字でテスト
5. **並行アクセス**: `go test -race`で競合状態をテスト
6. **エラーパス**: 操作が失敗した場合の動作をテスト
7. **クリーンアップ**: クリーンアップ関数（defer、closeなど）をテスト
8. **オーバーフロー/アンダーフロー**: 算術演算の境界をテスト
9. **型変換**: 精度損失と切り捨てをテスト
10. **プラットフォーム差異**: OS固有の動作を考慮（ファイルパス、改行など）

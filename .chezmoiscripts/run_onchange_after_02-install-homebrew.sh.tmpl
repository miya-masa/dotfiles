#!/usr/bin/env bash

set -o nounset
set -o errexit
trap 'echo "Aborting due to errexit on line $LINENO. Exit code: $?" >&2' ERR
set -o errtrace
set -o pipefail
IFS=$'\n\t'

function has() {
  type "$1" >/dev/null 2>&1
}

echo "🍺 Installing Homebrew and packages..."

{{- if eq .chezmoi.os "linux" }}
# Install Homebrew for Linux
export NONINTERACTIVE=1
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# Brewfile_linux hash: {{ include "Brewfile_linux" | sha256sum }}
# Install packages from Brewfile_linux
if command -v brew >/dev/null 2>&1; then
  brew bundle --file=Brewfile_linux
else
  /home/linuxbrew/.linuxbrew/bin/brew bundle --file=Brewfile_linux
fi

{{- else if eq .chezmoi.os "darwin" }}
# Install Homebrew for macOS
if ! has brew; then
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

# Brewfile_mac hash: {{ include "Brewfile_mac" | sha256sum }}
# Install packages from Brewfile_mac
brew bundle --file=Brewfile_mac
{{- end }}

echo "✅ Homebrew and packages installed successfully!"

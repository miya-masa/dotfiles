#!/usr/bin/env bash
{{- if and (eq .chezmoi.os "linux") (eq .chezmoi.osRelease.id "ubuntu") }}

set -o nounset
set -o errexit
trap 'echo "Aborting due to errexit on line $LINENO. Exit code: $?" >&2' ERR
set -o errtrace
set -o pipefail
IFS=$'\n\t'

function has() {
  type "$1" >/dev/null 2>&1
}

echo "🐳 Installing Docker..."

# Skip if Docker is already installed
if has docker; then
  echo "✅ Docker is already installed"
  exit 0
fi

# Install Docker CE for Ubuntu
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# Add user to docker group
sudo usermod -aG docker {{ .chezmoi.username }}

# Enable and start Docker service
sudo systemctl enable docker
sudo systemctl start docker

echo "✅ Docker installed successfully!"
echo "📌 Please log out and log back in to use Docker without sudo"

{{- end }}